package rqcode.tutorial.tutorial_new;
import rqcode.concepts.Requirement;

import rqcode.concepts.Checkable;

import java.util.HashMap;
import java.util.Map;

public class PasswordLockoutRequirement extends Requirement {
    private static final int MAX_FAILED_ATTEMPTS = 5; // Maximum allowed failed attempts
    private static final long LOCKOUT_DURATION_MS = 15 * 60 * 1000; // Lockout duration in milliseconds (15 minutes)
    private final Map<String, UserLoginStatus> userLoginStatusMap = new HashMap<>();
    private final String username;

    public PasswordLockoutRequirement(String username) {
        this.username = username;
    }

    @Override
    public Checkable.CheckStatus check() {
        UserLoginStatus status = userLoginStatusMap.getOrDefault(username, new UserLoginStatus());

        if (status.isLocked()) {
            if (System.currentTimeMillis() - status.getLockoutStartTime() > LOCKOUT_DURATION_MS) {
                status.resetLockout(); // Unlock the account after the lockout period
            } else {
                return Checkable.CheckStatus.FAIL;
            }
        }

        if (status.getFailedAttempts() >= MAX_FAILED_ATTEMPTS) {
            status.lock();
            return Checkable.CheckStatus.FAIL;
        }

        return Checkable.CheckStatus.PASS;
    }

    public void recordFailedAttempt() {
        UserLoginStatus status = userLoginStatusMap.getOrDefault(username, new UserLoginStatus());
        status.incrementFailedAttempts();
        userLoginStatusMap.put(username, status);
    }

    public void resetFailedAttempts() {
        UserLoginStatus status = userLoginStatusMap.getOrDefault(username, new UserLoginStatus());
        status.resetFailedAttempts();
        userLoginStatusMap.put(username, status);
    }

    @Override
    public String toString() {
        return "The system must lock a userâ€™s account after " + MAX_FAILED_ATTEMPTS + " consecutive failed login attempts.";
    }

    private static class UserLoginStatus {
        private int failedAttempts = 0;
        private long lockoutStartTime = 0;

        public int getFailedAttempts() {
            return failedAttempts;
        }

        public void incrementFailedAttempts() {
            this.failedAttempts++;
        }

        public void resetFailedAttempts() {
            this.failedAttempts = 0;
        }

        public boolean isLocked() {
            return lockoutStartTime > 0;
        }

        public long getLockoutStartTime() {
            return lockoutStartTime;
        }

        public void lock() {
            this.lockoutStartTime = System.currentTimeMillis();
        }

        public void resetLockout() {
            this.lockoutStartTime = 0;
        }
    }
}
